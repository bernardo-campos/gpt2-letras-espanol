<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Letras de Canciones</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        /* Estilos personalizados mínimos para el resaltado y pre-wrap */
        .highlight {
            background-color: #fde047; /* Tailwind yellow-200 */
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .generation-text {
            white-space: pre-wrap; /* Para respetar los saltos de línea (\n) */
            word-wrap: break-word; /* Para evitar desbordamiento en palabras largas */
        }
        /* Estilo para el indicador gráfico de palabras */
        .word-bar {
            background-color: #60a5fa; /* Tailwind blue-400 */
            height: 8px;
            border-radius: 4px;
        }
        /* Estilo para el texto seleccionado de palabras frecuentes */
        .selected-word-tag {
            background-color: #a78bfa; /* Tailwind violet-400 */
            color: white;
            padding: 4px 8px;
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .unselected-word-tag {
            background-color: #e5e7eb; /* Tailwind gray-200 */
            color: #4b5563; /* Tailwind gray-700 */
            padding: 4px 8px;
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        /* Estilos para el slider */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4f46e5; /* Tailwind indigo-600 */
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #4f46e5; /* Tailwind indigo-600 */
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 antialiased p-4 sm:p-6 md:p-8">
    <div id="app" class="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6 sm:p-8 md:p-10">
        <!-- Título y Subtítulo -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700 mb-2">Análisis de Letras de Canciones</h1>
            <p class="text-xl sm:text-2xl text-gray-600">Exploración de patrones léxicos y generaciones con IA</p>
        </header>

        <!-- Selector de Artista y Navegación de Pestañas -->
        <section class="mb-8 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="w-full sm:w-auto flex-grow">
                <label for="artist-select" class="block text-lg font-semibold text-gray-700 mb-2">Selecciona un Artista:</label>
                <select id="artist-select" v-model="selectedArtist" @change="resetGenerationsAndWords"
                        class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg bg-white">
                    <option v-for="artistName in artists" :key="artistName" :value="artistName">
                        {{ artistName }}
                    </option>
                </select>
            </div>

            <div class="w-full sm:w-auto flex-shrink-0 flex space-x-2 bg-gray-200 rounded-lg p-1">
                <button @click="activeTab = 'artist'"
                        :class="{'bg-indigo-600 text-white shadow-md': activeTab === 'artist', 'bg-white text-gray-700': activeTab !== 'artist'}"
                        class="flex-1 px-4 py-2 rounded-md text-base font-medium transition-colors duration-200">
                    Estadísticas del Artista
                </button>
                <button @click="activeTab = 'global'"
                        :class="{'bg-indigo-600 text-white shadow-md': activeTab === 'global', 'bg-white text-gray-700': activeTab !== 'global'}"
                        class="flex-1 px-4 py-2 rounded-md text-base font-medium transition-colors duration-200">
                    Estadísticas Globales
                </button>
            </div>
        </section>

        <!-- Contenido Principal: Pestaña de Artista -->
        <div v-if="activeTab === 'artist'">
            <div v-if="selectedArtistData" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Sección de Estadísticas del Artista -->
                <div class="lg:col-span-1 bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-4">Estadísticas de {{ selectedArtist }}</h2>
                    <ul class="space-y-2 text-lg text-gray-700">
                        <li><span class="font-semibold">Palabras Totales:</span> {{ selectedArtistData.stats.totalWords.toLocaleString() }}</li>
                        <li><span class="font-semibold">Palabras Únicas:</span> {{ selectedArtistData.stats.uniqueWords.toLocaleString() }}</li>
                        <li><span class="font-semibold">Canciones:</span> {{ selectedArtistData.stats.songs.toLocaleString() }}</li>
                        <li><span class="font-semibold">Promedio de Palabras por Canción:</span> {{ selectedArtistData.stats.avgWordsPerSong.toFixed(2) }}</li>
                    </ul>
                </div>

                <!-- Sección de Listado de Palabras -->
                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-4">Palabras Más Frecuentes en el dataset de {{ selectedArtist }}</h2>

                    <!-- Slider para cantidad de palabras -->
                    <div class="mb-6">
                        <label for="words-slider" class="block text-lg font-semibold text-gray-700 mb-2">
                            Mostrar {{ wordsToShowCount }} palabras
                        </label>
                        <input type="range" id="words-slider" v-model="wordsToShowCount" min="5" :max="maxWordsSlider" step="5"
                               class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Tabla de Palabras -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">Palabra</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Conteo</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-lg">Indicador</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr v-for="(word, index) in filteredWords" :key="index" class="hover:bg-gray-50 transition-colors duration-150">
                                    <td class="py-0 px-4 text-base text-gray-900">{{ word.word }}</td>
                                    <td class="py-0 px-4 text-base text-gray-700">{{ word.count.toLocaleString() }}</td>
                                    <td class="py-0 px-4">
                                        <div class="word-bar" :style="{ width: (word.count / maxWordCount) * 100 + '%' }"></div>
                                    </td>
                                </tr>
                                <tr v-if="filteredWords.length === 0">
                                    <td colspan="3" class="py-4 px-4 text-center text-gray-500 text-lg">No hay palabras para mostrar.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sección de Generaciones de Texto -->
            <div class="mt-8 bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4">Generaciones con IA para {{ selectedArtist }}</h2>

                <div v-if="selectedArtistData.generations && selectedArtistData.generations.length > 0">
                    <!-- Palabras frecuentes seleccionables -->
                    <div class="mb-4 flex flex-wrap gap-2 items-center">
                        <span class="text-lg font-semibold text-gray-700 mr-2">Palabras para resaltar:</span>
                        <span v-for="wordObj in mostFrequentWordsForHighlight" :key="wordObj.word"
                              :class="{'selected-word-tag': selectedFrequentWords.includes(wordObj.word), 'unselected-word-tag': !selectedFrequentWords.includes(wordObj.word)}"
                              @click="toggleWordSelection(wordObj.word)">
                            {{ wordObj.word }}
                        </span>
                        <span v-if="mostFrequentWordsForHighlight.length === 0" class="text-gray-500 text-sm">
                            No hay palabras frecuentes para resaltar en esta vista.
                        </span>
                    </div>

                    <!-- Título de la generación -->
                    <!-- <h3 class="text-xl font-semibold text-gray-800 mb-3">{{ currentGeneration.title }}</h3> -->

                    <!-- Contenedor de texto de la generación -->
                    <div class="bg-white p-6 rounded-lg border border-gray-300 shadow-sm mb-6 max-h-96 overflow-y-auto" style="min-height: min-content;">
                        <p class="generation-text text-lg text-gray-800" v-html="highlightText(currentGeneration.text)"></p>
                    </div>

                    <!-- Controles de navegación de generaciones -->
                    <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4">
                        <button @click="prevGeneration" :disabled="currentGenerationIndex === 0"
                                class="w-full sm:w-auto px-6 py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            Anterior
                        </button>

                        <div class="flex-grow text-center">
                            <label for="generation-slider" class="block text-lg font-semibold text-gray-700 mb-2">
                                Generación {{ Number(currentGenerationIndex) + 1 }} de {{ selectedArtistData.generations.length }}
                            </label>
                            <input type="range" id="generation-slider" v-model="currentGenerationIndex" min="0" :max="selectedArtistData.generations.length - 1" step="1"
                                   class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <button @click="nextGeneration" :disabled="currentGenerationIndex === selectedArtistData.generations.length - 1"
                                class="w-full sm:w-auto px-6 py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            Siguiente
                        </button>
                    </div>
                </div>
                <div v-else class="text-center text-gray-500 text-lg py-8">
                    No hay generaciones de texto disponibles para este artista.
                </div>
            </div>
        </div>

        <!-- Contenido Principal: Pestaña de Estadísticas Globales -->
        <div v-if="activeTab === 'global'">
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200">
                <h2 class="text-2xl font-bold text-indigo-600 mb-6">Estadísticas Globales por Artista</h2>

                <!-- Tabla de Estadísticas Globales -->
                <div class="mb-8 overflow-x-auto">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Resumen de Estadísticas</h3>
                    <table class="min-w-full bg-white rounded-lg shadow-md border border-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">Artista</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Palabras Totales</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Palabras Únicas</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Canciones</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-lg">Palabras/Canción (Promedio)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr v-for="(stats, artistName) in globalArtistStats" :key="artistName" class="hover:bg-gray-50 transition-colors duration-150">
                                <td class="py-3 px-4 text-base text-gray-900 font-medium">{{ artistName }}</td>
                                <td class="py-3 px-4 text-base text-gray-700">{{ stats.totalWords.toLocaleString() }}</td>
                                <td class="py-3 px-4 text-base text-gray-700">{{ stats.uniqueWords.toLocaleString() }}</td>
                                <td class="py-3 px-4 text-base text-gray-700">{{ stats.songs.toLocaleString() }}</td>
                                <td class="py-3 px-4 text-base text-gray-700">{{ stats.avgWordsPerSong.toFixed(2) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Tabla de Palabras Más Frecuentes por Artista Global -->
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Palabras Más Frecuentes por Artista (Top 5)</h3>
                    <table class="min-w-full bg-white rounded-lg shadow-md border border-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">Artista</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-lg">Palabras Frecuentes (Palabra: Conteo)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr v-for="(words, artistName) in globalFrequentWords" :key="artistName" class="hover:bg-gray-50 transition-colors duration-150">
                                <td class="py-3 px-4 text-base text-gray-900 font-medium">{{ artistName }}</td>
                                <td class="py-3 px-4 text-base text-gray-700">
                                    <span v-if="words.length > 0">
                                        {{ words.map(w => `${w.word}: ${w.count}`).join(', ') }}
                                    </span>
                                    <span v-else class="text-gray-500">N/A</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Mensajes de carga y error -->
        <div v-if="loading" class="text-center text-indigo-600 text-xl font-semibold mt-8">Cargando datos...</div>
        <div v-if="error" class="text-center text-red-600 text-xl font-semibold mt-8">Error al cargar los datos: {{ error }}</div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // Datos reactivos
                const artistData = ref(null);
                const selectedArtist = ref('');
                const wordsToShowCount = ref(10); // Valor inicial del slider
                const currentGenerationIndex = ref(0);
                const selectedFrequentWords = ref([]);
                const activeTab = ref('artist'); // 'artist' o 'global'
                const loading = ref(true);
                const error = ref(null);

                // Función para cargar los datos del JSON
                const loadArtistData = async () => {
                    try {
                        const response = await fetch('artist_analysis_data.json');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        artistData.value = await response.json();
                        // Seleccionar el primer artista por defecto
                        if (Object.keys(artistData.value).length > 0) {
                            selectedArtist.value = Object.keys(artistData.value)[0];
                        }
                    } catch (e) {
                        error.value = e.message;
                        console.error("Error al cargar los datos del artista:", e);
                    } finally {
                        loading.value = false;
                    }
                };

                // Propiedad computada para obtener los nombres de los artistas
                const artists = computed(() => {
                    return artistData.value ? Object.keys(artistData.value) : [];
                });

                // Propiedad computada para obtener los datos del artista seleccionado
                const selectedArtistData = computed(() => {
                    return artistData.value && selectedArtist.value ? artistData.value[selectedArtist.value] : null;
                });

                // Propiedad computada para obtener las palabras filtradas y ordenadas del artista seleccionado
                const filteredWords = computed(() => {
                    if (!selectedArtistData.value || !selectedArtistData.value.words) {
                        return [];
                    }
                    // Ordenar por conteo de mayor a menor y limitar por wordsToShowCount
                    return [...selectedArtistData.value.words]
                        .sort((a, b) => b.count - a.count)
                        .slice(0, wordsToShowCount.value);
                });

                // Propiedad computada para el valor máximo del indicador gráfico de palabras
                const maxWordCount = computed(() => {
                    if (!filteredWords.value.length) {
                        return 1; // Evitar división por cero
                    }
                    return filteredWords.value[0].count; // La palabra con el conteo más alto
                });

                // Propiedad computada para el valor máximo del slider de palabras a mostrar
                const maxWordsSlider = computed(() => {
                    return selectedArtistData.value && selectedArtistData.value.words ? selectedArtistData.value.words.length : 100;
                });

                // Propiedad computada para obtener la generación actual
                const currentGeneration = computed(() => {
                    if (!selectedArtistData.value || !selectedArtistData.value.generations || selectedArtistData.value.generations.length === 0) {
                        return { title: 'N/A', text: 'No hay generaciones disponibles.' };
                    }
                    return selectedArtistData.value.generations[currentGenerationIndex.value];
                });

                // Propiedad computada para las palabras más frecuentes para resaltar (las 10 primeras de la lista filtrada)
                const mostFrequentWordsForHighlight = computed(() => {
                    return filteredWords.value.slice(0, 20); // Tomar las 20 primeras palabras de la lista filtrada
                });

                // Método para navegar a la generación anterior
                const prevGeneration = () => {
                    if (currentGenerationIndex.value > 0) {
                        currentGenerationIndex.value--;
                    }
                };

                // Método para navegar a la siguiente generación
                const nextGeneration = () => {
                    if (selectedArtistData.value && currentGenerationIndex.value < selectedArtistData.value.generations.length - 1) {
                        currentGenerationIndex.value++;
                    }
                };

                // Método para alternar la selección de una palabra para resaltar
                const toggleWordSelection = (word) => {
                    const index = selectedFrequentWords.value.indexOf(word);
                    if (index > -1) {
                        selectedFrequentWords.value.splice(index, 1); // Deseleccionar
                    } else {
                        selectedFrequentWords.value.push(word); // Seleccionar
                    }
                };

                // Método para resaltar palabras en el texto de la generación
                const highlightText = (text) => {
                    if (!text) return '';
                    let highlighted = text;
                    selectedFrequentWords.value.forEach(word => {
                        // Usar una expresión regular global e insensible a mayúsculas/minúsculas
                        const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                        highlighted = highlighted.replace(regex, `<span class="highlight">$&</span>`);
                    });
                    // // Reemplazar <eos> si existe
                    highlighted = highlighted.replace(/<eos>/g, "&lt;eos&gt;");
                    // highlighted = highlighted.replace(/<eos>/g, '');

                    return highlighted;
                };

                // Propiedad computada para las estadísticas globales de artistas
                const globalArtistStats = computed(() => {
                    if (!artistData.value) return {};
                    const stats = {};
                    for (const artistName in artistData.value) {
                        stats[artistName] = artistData.value[artistName].stats;
                    }
                    return stats;
                });

                // Propiedad computada para las palabras más frecuentes por artista (global)
                const globalFrequentWords = computed(() => {
                    if (!artistData.value) return {};
                    const freqWords = {};
                    for (const artistName in artistData.value) {
                        // Tomar las 5 palabras más frecuentes de cada artista para el resumen global
                        freqWords[artistName] = [...artistData.value[artistName].words]
                            .sort((a, b) => b.count - a.count)
                            .slice(0, 5);
                    }
                    return freqWords;
                });

                // Resetear el índice de generaciones y las palabras seleccionadas al cambiar de artista
                const resetGenerationsAndWords = () => {
                    currentGenerationIndex.value = 0;
                    selectedFrequentWords.value = [];
                    // Asegurarse de que wordsToShowCount no exceda el número de palabras del nuevo artista
                    if (selectedArtistData.value && wordsToShowCount.value > selectedArtistData.value.words.length) {
                        wordsToShowCount.value = selectedArtistData.value.words.length;
                    }
                };

                // Cargar los datos cuando el componente se monta
                onMounted(() => {
                    loadArtistData();
                });

                // Observar cambios en selectedArtist para resetear el índice de generaciones
                watch(selectedArtist, () => {
                    resetGenerationsAndWords();
                });

                return {
                    artistData,
                    selectedArtist,
                    wordsToShowCount,
                    currentGenerationIndex,
                    selectedFrequentWords,
                    activeTab,
                    loading,
                    error,
                    artists,
                    selectedArtistData,
                    filteredWords,
                    maxWordCount,
                    maxWordsSlider,
                    currentGeneration,
                    mostFrequentWordsForHighlight,
                    prevGeneration,
                    nextGeneration,
                    toggleWordSelection,
                    highlightText,
                    globalArtistStats,
                    globalFrequentWords,
                    resetGenerationsAndWords
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
